<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home Automation Control Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .device-container {
      margin-bottom: 30px;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .form-step {
      margin-top: 10px;
    }
    .hidden {
      display: none;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: #fff;
      margin-right: 5px; 
      margin-bottom: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .on-button {
      background-color: #28a745;
    }
    .off-button {
      background-color: #dc3545;
    }
    label {
      font-weight: bold;
    }
    #connection-status {
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: bold;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
    }
    .connecting {
      background-color: #fff3cd;
      color: #856404;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .info-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #e2f0fd;
      border-radius: 8px;
    }
  </style>
  <!-- Load the Paho MQTT library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <!-- Load our MQTT handling code -->
  <script src="mqtt.js" type="text/javascript"></script>
  <script type="text/javascript">
    // Keep track of connection attempts
    let connectionAttempts = 0;
    const MAX_ATTEMPTS = 3;
    
    window.onload = function() {
      // Check if Paho is available and initialize MQTT after a short delay
      setTimeout(function() {
        if (typeof Paho !== 'undefined' && Paho.MQTT) {
          console.log('✅ Paho MQTT is available - initializing MQTT');
          updateConnectionStatus("connecting");
          // Call the initialization function from mqtt.js
          if (typeof window.initializeMQTT === 'function') {
            window.initializeMQTT();
          } else {
            console.error('❌ initializeMQTT function not found');
            updateConnectionStatus("error");
          }
        } else {
          console.error('❌ Paho MQTT not available after load');
          updateConnectionStatus("error");
          
          // Try to load from alternative CDN if first attempt failed
          const script = document.createElement('script');
          script.src = "https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt.js";
          script.onload = function() {
            console.log('✅ Paho MQTT loaded from alternative CDN');
            setTimeout(function() {
              if (typeof window.initializeMQTT === 'function') {
                window.initializeMQTT();
              }
            }, 500);
          };
          script.onerror = function() {
            console.error('❌ Failed to load Paho MQTT from alternative CDN');
            document.getElementById('connection-status').textContent = 
              "Failed to load MQTT library. Please check your internet connection and refresh the page.";
          };
          document.head.appendChild(script);
        }
      }, 500);
    };
    
    function updateConnectionStatus(status) {
      const statusDiv = document.getElementById('connection-status');
      if (status === "connected") {
        statusDiv.textContent = "✅ Connected to MQTT Broker";
        statusDiv.className = "connected";
        // Enable all control buttons
        enableControls(true);
      } else if (status === "connecting") {
        connectionAttempts++;
        statusDiv.textContent = "⏳ Connecting to MQTT Broker... (Attempt " + connectionAttempts + " of " + MAX_ATTEMPTS + ")";
        statusDiv.className = "connecting";
        // Disable controls while connecting
        enableControls(false);
      } else if (status === "error") {
        if (connectionAttempts >= MAX_ATTEMPTS) {
          statusDiv.textContent = "❌ Failed to connect after multiple attempts. Check your internet connection or try again later.";
        } else {
          statusDiv.textContent = "❌ Disconnected from MQTT Broker. Trying to reconnect...";
        }
        statusDiv.className = "disconnected";
        // Disable controls when disconnected
        enableControls(false);
      }
    }
    
    function enableControls(enabled) {
      const buttons = document.querySelectorAll('button[onclick^="togglePower"], button[onclick^="resetDevice"]');
      buttons.forEach(button => {
        button.disabled = !enabled;
        if (!enabled) {
          button.style.opacity = "0.6";
          button.style.cursor = "not-allowed";
        } else {
          button.style.opacity = "1";
          button.style.cursor = "pointer";
        }
      });
    }
  </script>
</head>
<body>

  <h2>Home Automation Control Panel</h2>
  <div id="connection-status" class="connecting">⏳ Connecting to MQTT Broker...</div>

  <div id="devices">
    <!-- Device 1 -->
    <div class="device-container" id="device-1">
      <button id="add-btn-1" onclick="startAdd(1)">Add Device</button>
      <div class="form-step hidden" id="type-1">
        <label>Select Device Type:</label><br/>
        <input type="radio" name="deviceType-1" value="Light" onclick="showSwitch(1)"> Light
        <input type="radio" name="deviceType-1" value="Socket" onclick="showSwitch(1)"> Socket
      </div>
      <div class="form-step hidden" id="switch-1">
        <label>Power:</label><br/>
        <button id="on-btn-1" onclick="togglePower(1, 'on')" class="on-button">Turn ON</button>
        <button id="off-btn-1" onclick="togglePower(1, 'off')" class="off-button hidden">Turn OFF</button>
      </div>
      <button onclick="resetDevice(1)">Reset</button>
    </div>

    <!-- Device 2 -->
    <div class="device-container" id="device-2">
      <button id="add-btn-2" onclick="startAdd(2)">Add Device</button>
      <div class="form-step hidden" id="type-2">
        <label>Select Device Type:</label><br/>
        <input type="radio" name="deviceType-2" value="Light" onclick="showSwitch(2)"> Light
        <input type="radio" name="deviceType-2" value="Socket" onclick="showSwitch(2)"> Socket
      </div>
      <div class="form-step hidden" id="switch-2">
        <label>Power:</label><br/>
        <button id="on-btn-2" onclick="togglePower(2, 'on')" class="on-button">Turn ON</button>
        <button id="off-btn-2" onclick="togglePower(2, 'off')" class="off-button hidden">Turn OFF</button>
      </div>
      <button onclick="resetDevice(2)">Reset</button>
    </div>
  </div>
  
  <div class="info-section">
    <h3>Connection Information</h3>
    <p>This interface connects to public MQTT brokers for testing purposes. In a production environment, you would use your own secure MQTT broker.</p>
    <p>If connection fails, the system will automatically try alternative public brokers.</p>
  </div>

  <script>
    // Override connection callbacks to update UI
    function updateConnectionStatus(status) {
      const statusDiv = document.getElementById('connection-status');
      if (status === true) {
        statusDiv.textContent = "✅ Connected to MQTT Broker";
        statusDiv.className = "connected";
        // Enable all controls
        enableControls(true);
      } else {
        statusDiv.textContent = "❌ Disconnected from MQTT Broker. Trying to reconnect...";
        statusDiv.className = "disconnected";
        // Disable controls
        enableControls(false);
      }
    }
  </script>
</body>
</html>